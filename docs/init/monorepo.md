# monorepo

## ä»€ä¹ˆæ˜¯ monorepo

monorepo æŒ‡çš„æ˜¯ä¸€ä¸­ä»£ç é¡¹ç›®ç»“æ„çš„ç»„ç»‡æ–¹å¼ï¼Œmono æ˜¯æŒ‡å•ä¸ªï¼Œrepo æ˜¯æŒ‡ä»“åº“ï¼Œæ€»çš„æ¥è¯´å°±æ˜¯å•ä¸ªä»“åº“ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯æŠŠæ‰€æœ‰ç›¸å…³çš„é¡¹ç›®æ”¾åˆ°ä¸€ä¸ªä»“åº“ä¸­è¿›è¡Œç®¡ç†

**ä¼˜ç‚¹**ï¼š

- å…¬å…±åŸºç¡€è®¾ç½®ï¼Œä¸ç”¨é‡å¤é…ç½®
- æœ‰ä¾èµ–çš„é¡¹ç›®ä¹‹é—´è°ƒè¯•å¼€å‘éå¸¸æ–¹ä¾¿
- ç¬¬ä¸‰æ–¹åº“çš„ç‰ˆæœ¬ç®¡ç†æ›´åŠ ç®€å•

## ä» Vue3 æºç å…¥é—¨çº§ç†è§£ pnpm çš„ monorepo

vue3 åœ¨æ¨¡å—çš„æ‹†åˆ†å’Œè®¾è®¡ä¸Šéå¸¸åˆç†ï¼Œæ¨¡å—ä¹‹é—´çš„è€¦åˆåº¦éå¸¸ä½ï¼Œå¾ˆå¤šæ¨¡å—å¯ä»¥ç‹¬ç«‹å®‰è£…ä½¿ç”¨ï¼Œè€Œä¸éœ€è¦å®Œæ•´çš„ä»¥æ¥ vue3 è¿è¡Œæ—¶ã€‚è¿™ç§å®ç°é™¤äº†ä»£ç å±‚é¢çš„è®¾è®¡ä¹‹å¤–ï¼Œæœ€é‡è¦çš„è¿˜æ˜¯ monorepo å¯¹é¡¹ç›®ä»£ç è¿›è¡Œç»„ç»‡ç®¡ç†

### vue3 ä¸­çš„ monorepo

vue3 ç›®å‰ä½¿ç”¨çš„æ˜¯ pnpm çš„ monorepoã€‚
åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­æ–°å»º pnpm-workspace.yaml æ–‡ä»¶ï¼Œå¹¶å£°æ˜å¯¹åº”çš„å·¥ä½œåŒºå°±å¯ä»¥äº†

```yaml
packages:
  - "packages/*"
```

è¡¨ç¤º packege/\*è¿™ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ä¸º workspace çš„å†…å®¹
![Alt text](image-1.png)
ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ° Vue3 æºç æ•´ä½“æ˜¯é€šè¿‡ monorepo æ–¹å¼è¿›è¡Œç®¡ç†ï¼Œå¹¶æ ¹æ®åŠŸèƒ½çš„ä¸åŒåœ¨ packages ç›®å½•ä¸‹è¿›è¡Œåˆ’åˆ†ä¸åŒçš„æ¨¡å—ç›®å½•ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ªç›®å½•ä¸‹é¢éƒ½ä¸€ä¸ª package.json æ–‡ä»¶ï¼Œä»£è¡¨æ¯ä¸€ä¸ªç›®å½•éƒ½æ˜¯ä¸€ä¸ª npm åŒ…ï¼Œæ¯ä¸ªåŒ…æœ‰å„è‡ªçš„ APIã€ç±»å‹å®šä¹‰å’Œæµ‹è¯•æ¨¡å—ä»¥åŠ Readme æ–‡æ¡£ã€‚è¿™æ ·å°±å¯ä»¥å°†æ¨¡å—æ‹†åˆ†å¾—æ›´ç»†çš„é¢—ç²’åº¦ï¼ŒèŒè´£åˆ’åˆ†ä¹Ÿæ›´æ˜ç¡®ã€‚

ç”±äºæ‰€æœ‰é¡¹ç›®éƒ½æ”¾åœ¨ä¸€ä¸ªä»“åº“ä¸­ï¼Œä»£ç é€»è¾‘æœç”¨éå¸¸æ–¹ä¾¿ï¼Œå¦‚æœæœ‰ä¾èµ–çš„ä»£ç å‘ç”Ÿå˜åŠ¨ï¼Œé‚£ä¹ˆç”¨åˆ°è¿™ä¸ªä¾èµ–çš„é¡¹ç›®å°±ä¼šç«‹é©¬æ„ŸçŸ¥åˆ°ã€‚è¿™åˆæ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿæ™®é€šé¡¹ç›®å¯ä»¥é€šè¿‡ç›¸å¯¹è·¯å¾„è¿›è¡Œå¼•ç”¨ï¼Œä½†æˆ‘ä»¬è¿™é‡Œçš„è®¾æƒ³æ˜¯æ¯ä¸€ä¸ªåŒ…éƒ½æ˜¯ç‹¬ç«‹ï¼Œå¦‚æœé€šè¿‡ç›¸å¯¹è·¯å¾„è¿›è¡Œå¼•ç”¨ï¼Œé‚£ä¹ˆå°±ä¼šéå¸¸è€¦åˆã€‚æ‰€æœ‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ï¼Œworkspace åè®®è¿›è¡Œæ¨¡å—ä¹‹é—´çš„ç›¸äº’ä¾èµ–ï¼Œè¾¾åˆ°è§£è€¦çš„ç›®çš„

### Workspace åè®®ï¼Œæ¨¡å—ä¹‹é—´çš„ç›¸äº’ä¾èµ–ã€

vue3 ä¸­ï¼Œå“åº”å¼æ–¹é¢çš„åŠŸèƒ½éƒ½æ˜¯ä½¿ç”¨`@vue/reactivity`åŒ…çš„,è¿™äº›åŒ…éƒ½å¯ä»¥åœ¨ npmjs ä¸­ä¸‹è½½ã€‚å½“æœ¬åœ°çš„æ—¶å€™ï¼Œåªéœ€è¦åœ¨é¡¹ç›®çš„`package.json`è¿›è¡Œä¸‹é¢è®¾ç½®

```js
{
  '@vue/reactivity:"workspace:*"',
  '@vue/runtime-core:"workspace:*"',
  '@vue/runtime-dom:"workspace:*"',

}

```

æœ¬åœ° workspace åŒ…åªè¦è¿›è¡Œ`workspace`åè®®ï¼Œè¿™æ ·å°±ä¾èµ–æœ¬åœ°çš„åŒ…äº†ï¼Œè€Œéœ€è¦ä» npmjs è¿›è¡Œå®‰è£…ä¸‹è½½ã€‚è¿˜æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯å­åŒ…ç›¸äº’å¼•ç”¨ä»£ç æ—¶ï¼Œä½¿ç”¨`workspace:*`çš„å†™æ³•æ¥é“¾æ¥å­åŒ…ï¼Œè€Œä¸æ˜¯å…·ä½“çš„ç‰ˆæœ¬å·ï¼Œå¯ä»¥é˜²æ­¢å¤šäººåä½œæ—¶å› ä¸ºä¿®æ”¹ç‰ˆæœ¬çš„é—æ¼è€Œå‘ç”Ÿå†²çªã€‚

é€šè¿‡ monorepo æ–¹å¼è¿›è¡Œç®¡ç†çš„é¡¹ç›®ï¼Œæ¯ä¸€ä¸ªæ¨¡å—éƒ½å¯ä»¥è¯´æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„é¡¹ç›®ï¼ŒåŒæ—¶å’Œå…¶ä»–é¡¹ç›®å¤ç”¨ä¸€å¥—æ ‡å‡†çš„å·¥å…·å’Œè§„èŒƒï¼Œæ— éœ€åˆ‡æ¢å¼€å‘ç¯å¢ƒã€‚ æ¯”å¦‚æˆ‘ä»Šå¤©åªä¿®æ”¹äº† reactivity é¡¹ç›®ï¼Œé‚£ä¹ˆæˆ‘å°±å¯ä»¥åªå¯¹ reactivity é¡¹ç›®è¿›è¡Œæ‰“åŒ…å¤„ç†ã€‚

`pnpm run build` æ˜¯æ‰“åŒ…æ‰€æœ‰æ¨¡å—ï¼Œåœ¨åé¢åŠ æ¨¡å—åç§°åˆ™æ˜¯å…·ä½“æ‰“åŒ…æ‰€åŠ çš„æ¨¡å—åç§°çš„æ¨¡å—ã€‚
å•ç‹¬æ‰“åŒ… reactivity æ¨¡å—ï¼š
`pnpm run build reactivity`
è¿™æ ·å°±å¯ä»¥å•ç‹¬æŠŠæ‰“åŒ…å‡ºæ¥çš„å†…å®¹å•ç‹¬å‘å¸ƒ

è€Œå¯¹ reactivity é¡¹ç›®è¿›è¡Œæ‰“åŒ…å¤„ç†çš„æŒç»­é›†æˆ(CI)æµç¨‹ã€æ„å»ºå’Œå‘å¸ƒæµç¨‹éƒ½æ˜¯å’Œå…¶ä»–é¡¹ç›®å…±ç”¨çš„æœ‰çš„åŸºå»ºæµç¨‹ï¼Œå³ä¾¿å°†æ¥æœ‰æ–°çš„é¡¹ç›®æ¥å…¥ï¼Œä¾ç„¶å¯ä»¥å¤ç”¨ç°åœ¨çš„åŸºå»ºé€»è¾‘ä»£ç ï¼Œè¿™æ ·ç»´æŠ¤å’Œå¼€å‘æˆæœ¬å°±å¤§å¤§é™ä½äº†ã€‚

### workspace åŒ…çš„ç‰ˆæœ¬

workspace:_åé¢çš„ _ è¡¨ç¤ºä»»æ„ç‰ˆæœ¬ï¼Œé™¤äº† \* è¿˜æœ‰å…¶ä»–ï¼š~ ã€^ ç¬¦å·ã€‚
å½“ workspace åŒ…æ‰“åŒ…å‘å¸ƒæ—¶ï¼Œå°†ä¼šåŠ¨æ€æ›¿æ¢è¿™äº› workspace: ä¾èµ–ã€‚
å‡è®¾æˆ‘ä»¬ä¸Šé¢çš„åŒ…çš„ç‰ˆæœ¬éƒ½æ˜¯ 1.0.0 ï¼Œå®ƒä»¬çš„ workspace é…ç½®å¦‚ä¸‹ï¼š

```js
{
  "dependencies": {
    "@vue/reactivity": "workspace:*",
    "@vue/runtime-core": "workspace:~",
    "@vue/runtime-dom": "workspace:^"
  },
}

```

å°†æ¥å‘åŒ…çš„æ—¶å€™ï¼Œä½¿ç”¨ç›¸å…³çš„å‘åŒ…å·¥å…·ï¼Œæ¯”å¦‚ä½¿ç”¨ changesets æ¥å‘åŒ…ï¼Œè¯¥å·¥å…·ä¼šå¸®ä½ è‡ªåŠ¨å‡çº§ç‰ˆæœ¬ã€äº§ç”Ÿ CHANGELOG ã€è‡ªåŠ¨æ›¿æ¢ workspace:\* ä¸ºå…·ä½“ç‰ˆæœ¬ã€è‡ªåŠ¨ä¿æŒç‰ˆæœ¬ä¸€è‡´æ€§ã€‚
æ¯”å¦‚ä¸Šé¢çš„ä»£ç å°†æ¥å‘å¸ƒçš„æ—¶å€™å°†ä¼šè¢«è½¬åŒ–ä¸ºï¼š

```js
{
  "dependencies": {
    "@vue/reactivity": "workspace:1.0.0",
    "@vue/runtime-core": "workspace:~1.0.0",
    "@vue/runtime-dom": "workspace:^1.0.0"
  },
}
```

[Monorepo - ä¼˜åŠ£ã€è¸©å‘ã€é€‰å‹](https://juejin.cn/post/7215886869199896637)
[ä¸ºä»€ä¹ˆè¶Šæ¥è¶Šå¤šçš„é¡¹ç›®é€‰æ‹© Monorepoï¼Ÿ](https://juejin.cn/post/7207743145999368229)

## ä»¥ pnpm è¿›è¡Œ monorepo ç¯å¢ƒçš„æ­å»º

### workspace æ¨¡å¼

pnpm æ”¯æŒ monorepo æ¨¡å¼çš„å·¥ä½œæœºåˆ¶å«åš workspace å·¥ä½œç©ºé—´ï¼Œ
ä»–è¦æ±‚åœ¨ä»£ç ä»“åº“çš„æ ¹ç›®å½•ä¸‹æœ‰`pnpm-workspace.yaml`æ–‡ä»¶æŒ‡å®šé‚£äº›ç›®å½•ä½œä¸ºç‹¬ç«‹çš„å·¥ä½œç©ºé—´ï¼Œè¿™ä¸ªå·¥ä½œç©ºé—´å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå­æ¨¡å—æˆ–è€… npm åŒ…ã€‚

```
ğŸ“¦my-project
 â”£ ğŸ“‚a
 â”ƒ â”— ğŸ“œpackage.json
 â”£ ğŸ“‚b
 â”ƒ â”— ğŸ“œpackage.json
 â”£ ğŸ“‚c
 â”ƒ â”£ ğŸ“‚c-1
 â”ƒ â”ƒ â”— ğŸ“œpackage.json
 â”ƒ â”£ ğŸ“‚c-2
 â”ƒ â”ƒ â”— ğŸ“œpackage.json
 â”ƒ â”— ğŸ“‚c-3
 â”ƒ   â”— ğŸ“œpackage.json
 â”£ ğŸ“œpackage.json
 â”£ ğŸ“œpnpm-workspace.yaml

```

```js
//pnpm-workspace.yaml
packages:
  - a
  - b
  - c/*
```

pnpm å¹¶ä¸æ˜¯é€šè¿‡ç›®å½•åç§°ï¼Œè€Œæ˜¯é€šè¿‡ç›®å½•ä¸‹çš„ package.json æ–‡ä»¶çš„ name å­—æ®µæ¥è¯†åˆ«ä»“åº“çš„åŒ…å’Œæ¨¡å—

### ä¸­æ¢ç®¡ç†æ“ä½œ

åœ¨ workspace æ¨¡å¼ä¸‹ï¼Œä»£ç ä»“åº“æ ¹ç›®å½•ä¸ä¼šä½œä¸ºä¸€ä¸ªå­æ¨¡å—æˆ–è€… npm åŒ…ï¼Œè€Œæ˜¯**ä¸»è¦ä½œä¸ºä¸€ä¸ªç®¡ç†ä¸­æ¢ï¼Œæ‰§è¡Œä¸€äº›å…¨å±€æ“ä½œï¼Œå®‰è£…ä¸€äº›å…±æœ‰çš„ä¾èµ–**

### å­åŒ…ç®¡ç†æ“ä½œ

åœ¨ workspace æ¨¡å¼ä¸‹ï¼Œpnpm é€šè¿‡`--filter`é€‰é¡¹è¿‡æ»¤å­æ¨¡å—ï¼Œå®ç°å¯¹å„ä¸ªå·¥ä½œç©ºé—´è¿›è¡Œç²¾ç»†åŒ–æ“ä½œçš„ç›®çš„

### å®æˆ˜ç¯èŠ‚ï¼Œåˆå§‹åŒ– monorepo å·¥ç¨‹

#### åˆ›å»ºé¡¹ç›®æ–‡ä»¶å¤¹å¹¶è¿›è¡Œåˆå§‹åŒ–

```bash
mkdir monorepo project
cd  monorepo project
pnpm init
```

#### åˆ›å»º pnpm-workspace.yaml æ–‡ä»¶

`pnpm-workspace.yaml`è¿™ä¸ªæ–‡ä»¶çš„å­˜åœ¨æœ¬èº«ï¼Œä¼šè®© pnpm è¦ä½¿ç”¨ monorepo çš„æ¨¡å¼ç®¡ç†è¿™ä¸ªé¡¹ç›®ï¼Œä»–çš„å†…å®¹å‘Šè¯‰ pnpm å“ªäº›ç›®å½•å°†è¢«åˆ’åˆ†ä¸ºç‹¬ç«‹çš„æ¨¡å—ï¼Œè¿™äº›æ‰€è°“çš„ç‹¬ç«‹æ¨¡å—è¢«åŒ…ç®¡ç†å™¨å«åš workspace(å·¥ä½œç©ºé—´)ã€‚æˆ‘ä»¬åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ã€‚

```yaml
packages:
  # æ ¹ç›®å½•ä¸‹çš„ docs æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ–‡æ¡£åº”ç”¨ï¼Œåº”è¯¥è¢«åˆ’åˆ†ä¸ºä¸€ä¸ªæ¨¡å—
  - docs
  # packages ç›®å½•ä¸‹çš„æ¯ä¸€ä¸ªç›®å½•éƒ½ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„æ¨¡å—
  - packages/*
```

æ¥ä¸‹æ¥å°±æ˜¯å»ºç«‹è¿™äº›å·¥ä½œç©ºé—´ï¼Œå¹¶å°†æ ¹ç›®å½•ä¸‹çš„`package.json`æ–‡ä»¶å¤åˆ¶åˆ°æ¯ä¸ªå·¥ä½œç©ºé—´ä¸­
æ¥ä¸‹æ¥å°±æ˜¯è®¾ç½® package.json

#### è®¾ç½® package.json

æ˜ç¡®æ¯ä¸€ä¸ªæ¨¡å—çš„å±æ€§ï¼Œè®¾ç½®ä»–ä»¬çš„ package.json æ–‡ä»¶

##### æ ¹ç›®å½•çš„ package.json

```json
// openx-ui/package.json
{
  "name": "openx-ui",
  "private": true,
  "scripts": {
    // å®šä¹‰è„šæœ¬
    "hello": "echo 'hello world'"
  },
  "devDependencies": {
    // å®šä¹‰å„ä¸ªæ¨¡å—çš„å…¬å…±å¼€å‘ä¾èµ–
  }
}
```

- `private:true`:æ ¹ç›®å½•åœ¨ monorepo æ¨¡å¼ä¸‹åªæ˜¯ä¸€ä¸ªç®¡ç†ä¸­æ¢ï¼Œå®ƒä¸ä¼šè¢«å‘å¸ƒä¸º npm åŒ… -` devDependencies`ï¼šæ‰€æœ‰æ¨¡å—éƒ½ä¼šæœ‰ä¸€äº›å…¬å…±çš„å¼€å‘ä¾èµ–ï¼Œä¾‹å¦‚æ„å»ºå·¥å…·ã€TypeScriptã€Vueã€ä»£ç è§„èŒƒç­‰ï¼Œå°†å…¬å…±å¼€å‘ä¾èµ–å®‰è£…åœ¨æ ¹ç›®å½•å¯ä»¥å¤§å¹…å‡å°‘å­æ¨¡å—çš„ä¾èµ–å£°æ˜ã€‚

##### ç»„ä»¶åŒ…çš„ package.json

```json
{
  //æ ‡è¯†ä¿¡æ¯
  "name": "@summary-project/cli",
  "version": "1.0.0",

  // åŸºæœ¬ä¿¡æ¯
  "description": "",
  "keywords": ["vue", "ui", "component library"],
  "author": "aky",
  "license": "MIT",
  "homepage": "git+https://github.com/xxx.git/xxx/README.md"
  "repository": {
    "type": "git",
    "url": "git+https://github.com/xxx.git"
  },
  "bugs": {
    "url" :"git+https://github.com/xxx.git/xxx/issue"
  }

  // å®šä¹‰è„šæœ¬ï¼Œç”±äºè¿˜æ²¡æœ‰é›†æˆå®é™…çš„æ„å»ºæµç¨‹ï¼Œè¿™é‡Œå…ˆä»¥æ‰“å°å‘½ä»¤ä»£æ›¿
  "scripts": {
    "build": "echo build",
    "test": "echo test"
  },

  // å…¥å£æ–‡ä»¶ç”±äºæ²¡æœ‰å®é™…äº§ç‰©ï¼Œå…ˆè®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²
  "main": "",
  "module": "",
  "types": "",
  "exports": {
    ".": {
      "require": "",
      "module": "",
      "types": ""
    }
  },

  // å‘å¸ƒä¿¡æ¯
  "files": [
    "dist",
    "README.md"
  ],
  // "publishConfig": {},

  // ä¾èµ–ä¿¡æ¯
  "peerDependencies": {
    "vue": ">=3.0.0"
  },
  "dependencies": {},
  "devDependencies": {}
}
```

##### é¡¹ç›®æ–‡æ¡£çš„ package.json

```json
// openx-ui/docs/package.json
{
  "name": "@openxui/docs",
  "private": true,
  "scripts": {
    // å®šä¹‰è„šæœ¬ï¼Œç”±äºè¿˜æ²¡æœ‰é›†æˆå®é™…çš„æ„å»ºæµç¨‹ï¼Œè¿™é‡Œå…ˆä»¥æ‰“å°å‘½ä»¤ä»£æ›¿
    "dev": "echo dev",
    "build": "echo build"
  },
  "dependencies": {
    // å®‰è£…æ–‡æ¡£ç‰¹æœ‰ä¾èµ–
  },
  "devDependencies": {
    // å®‰è£…æ–‡æ¡£ç‰¹æœ‰ä¾èµ–
  }
}
```

è‡³æ­¤,æˆ‘ä»¬çš„ monorepo é¡¹ç›®é›å½¢å·²ç»å»ºç«‹å®Œæ¯•.

[Monorepo pnpm æ¨¡å¼ç®¡ç†å¤šä¸ª web é¡¹ç›®](https://juejin.cn/post/7117897323014783013)

### monorepo ä¸‹é›†æˆ Vite

#### .npmrc æ–‡ä»¶

å®‰è£…ä¾èµ–ä¹‹å‰ï¼Œå…ˆç†Ÿæ‚‰ä¸‹.npmrc æ–‡ä»¶ï¼Œåœ¨æ ¹ç›®å½•ä¸‹å»ºç«‹.npmrc æ–‡ä»¶
è¿™ä¸ª.npmrc æ–‡ä»¶ç›¸å½“äºé¡¹ç›®çº§çš„ npm é…ç½®

```ini
registry=https://registry.npm.taobao.org

```

ä¸Šé¢çš„é…ç½®ç›¸å½“äºåˆ‡æ¢ npm é•œåƒæºä¸º https://registry.npm.taobao.orgï¼Œåªä¸è¿‡é…ç½®åªåœ¨å½“å‰é¡¹ç›®ç›®å½•ä¸‹ç”Ÿæ•ˆï¼Œä¼˜å…ˆçº§é«˜äºç”¨æˆ·è®¾ç½®çš„æœ¬åœ°é…ç½®ã€‚

è¿™ä¸ªæ•ˆæœç›¸å½“äº`npm set config registry https://registry.npm.taobao.org`.

å°†ä¸€äº›å¿…è¦çš„é…ç½®æ”¾åœ¨è¿™ä¸ªé¡¹ç›®çº§çš„ .npmrc æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”å°†è¿™ä¸ªæ–‡ä»¶æäº¤åˆ°ä»£ç ä»“ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿åç»­è´¡çŒ®çš„å…¶ä»–ç”¨æˆ·å…å»è®¸å¤šç¯å¢ƒé…ç½®çš„éº»çƒ¦ï¼Œå°¤å…¶æ˜¯åœ¨å…¬å¸çš„å†…ç½‘ç¯å¢ƒä¸‹ï¼Œå„å¼å„æ ·çš„ npm ç§ä»“å’Œä»£ç†é…ç½®è®©å¾ˆå¤šæ–°äººå¤´ç–¼ã€‚

å½“ç„¶ï¼Œå¦‚æœä½ æ˜¯å¼€æºé¡¹ç›®ï¼Œå°±ä¸æ˜¯å¾ˆæ¨èä½ åœ¨é‡Œé¢åšç½‘ç»œç¯å¢ƒç›¸å…³çš„é…ç½®äº†ï¼Œå› ä¸ºæ¯ä¸ªè´¡çŒ®è€…çš„ç½‘ç»œç¯å¢ƒæ˜¯å¤šæ ·åŒ–çš„ï¼Œè¿™æ—¶é¡¹ç›®çº§çš„ .npmrc å°±åªé€‚åˆæ”¾ä¸€äº›ä¸åŒ…ç®¡ç†ç›¸å…³çš„é…ç½®ã€‚

#### å®‰è£…å…¬å…±é¡¹ç›®æ„å»ºä¾èµ–

æ¥ä¸‹æ¥ï¼Œå°±æ˜¯åœ¨æ ¹ç›®å½•ä¸‹å®‰è£…æ‰€éœ€çš„æ„å»ºå·¥å…·ï¼š`Vite`å’Œ`Typescript`

```bash
pnpm i -wD vite typescript
```

å› ä¸ºæ¯ä¸ªåŒ…éƒ½éœ€è¦ç”¨åˆ° Vite å’Œ TypeScript è¿›è¡Œæ„å»ºï¼Œå…¬å…±å¼€å‘ä¾èµ–ç»Ÿä¸€å®‰è£…åœ¨æ ¹ç›®å½•ä¸‹ï¼Œæ˜¯å¯ä»¥è¢«å„ä¸ªå­åŒ…æ­£å¸¸ä½¿ç”¨
ç”±äºæˆ‘ä»¬è¦æ„å»ºçš„æ˜¯ Vue é¡¹ç›®ï¼ŒVue æ¨èçš„ç»„ä»¶å¼€å‘èŒƒå¼å•æ–‡ä»¶ç»„ä»¶ SFC å¹¶ä¸æ˜¯åŸç”Ÿçš„ Web å¼€å‘è¯­æ³•ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªç¼–è¯‘ä¸ºåŸç”Ÿ js çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼•å…¥ç›¸å…³çš„ Vite æ’ä»¶`@vitejs/plugin-vue`ï¼Œè¿™ä¸ªæ’ä»¶ç»§æ‰¿äº† Vue ç¼–è¯‘å™¨çš„èƒ½åŠ›ï¼Œæ˜¯çš„æ„å»ºå·¥å…·å¯ä»¥ç†è§£ vue sfc

```bash
pnpm i -wD @vitejs/plugin-vue

```

å¦å¤–éœ€è¦æ³¨æ„ï¼Œvue åº”è¯¥è¢«å®‰è£…åˆ°æ ¹ç›®å½•ä¸‹çš„ dependenciesï¼Œå› ä¸ºå‡ ä¹æ‰€æœ‰å­åŒ…çš„ peerDependencies ä¸­éƒ½å…·æœ‰ vue(peerDependencies)ï¼Œæˆ‘ä»¬ç»“åˆ pnpm çš„`resolve-peers-from-workspace-root` æœºåˆ¶ï¼Œå¯ä»¥ç»Ÿä¸€æ‰€æœ‰å­åŒ…ä¸­ vue çš„ç‰ˆæœ¬

å®‰è£… Vue

```bash
pnpm i -wS vue
```

å®‰è£… css é¢„å¤„ç†

```bash
pnpm i -wD sass
```

#### Vite é›†æˆ

ä¸ºäº†æˆåŠŸé›†æˆ Viteï¼Œè®©æˆ‘ä»¬çš„é›†æˆåº“æ„å»ºå‡ºäº§ç‰©ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å®Œæˆä¸‰ä¸ªæ­¥éª¤ï¼š

- ç¼–å†™æ„å»ºç›®æ ‡æºç ï¼Œç›®å‰çš„é‡ç‚¹æ˜¯å·¥ç¨‹åŒ–è€Œéç»„ä»¶åº“çš„å¼€å‘ï¼Œä»£ç å±‚é¢èƒ½å¤Ÿä½“ç°æ„å»ºè¦ç‚¹çš„ demo
- å‡†å¤‡ vite.config é…ç½®æ–‡ä»¶
- åœ¨ package.json ä¸­è®¾ç½®æ„å»ºè„šæœ¬

åœ¨é›†æˆ Vite è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œéå¸¸å¤šçš„æ‰©å±•

1. å¯¹äº package ç›®å½•ä¸‹çš„æ¯ä¸€ä¸ªç»„ä»¶åŒ…ï¼Œæˆ‘ä»¬åˆ¶å®šæ›´ç»†è‡´çš„æºç ç»„ç»‡è§„åˆ™

- å„ç§é…ç½®æ–‡ä»¶ï¼Œå¦‚`package.json`ã€`vite.config.ts(js)`éƒ½æ”¾åœ¨æ¨¡å—æ ¹ç›®å½•ä¸‹
- src ç›®å½•ä¸‹å­˜æ”¾æºç ï¼Œå…¶ä¸­`src/index.ts(js)`ä½œä¸ºæ¨¡å—çš„æ€»å‡ºå£ï¼Œæ‰€æœ‰éœ€è¦æš´éœ²ç»™å¤–éƒ¨ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨çš„æ–¹æ³•ã€å¯¹è±¡éƒ½è¦åœ¨è¿™é‡Œå£°æ˜å¯¼å‡ºã€‚
- dist ç›®å½•ä½œä¸ºäº§ç‰©çš„è¾“å‡ºç›®å½•

2. å¦‚æœæ˜¯ç»„ä»¶åº“ï¼Œå¯ä»¥åœ¨ packages ç›®å½•ä¸‹æ–°å»ºç»Ÿä¸€å‡ºå£åŒ…ã€‚å¦‚ element-plus ä¸»åŒ…è´Ÿè´£å„ä¸ªå­åŒ…ï¼Œå¹¶ç»Ÿä¸€å¯¼å‡ºå…¶ä¸­å†…å®¹
3. æµ‹è¯•æ¨¡å—ï¼Œå¯ä»¥æ ¹ç›®å½•ä¸‹æ–°å»º demo æ¨¡å—ï¼Œç”¨æ¥è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Ÿ
4. typescriptï¼Œtsconfig çš„æµ‹è¯•

å› ä¸ºæˆ‘ä»¬è§„å®šäº†æ¯ä¸ªæ¨¡å—çš„ dist éƒ½ä½œä¸ºäº§ç‰©è¾“å‡ºç›®å½•ï¼Œè€Œè¾“å‡ºäº§ç‰©æ˜¯ä¸éœ€è¦å…¥ä»“çš„(clone ä»£ç åæ‰§è¡Œæ„å»ºå‘½ä»¤å°±èƒ½ç”Ÿæˆ)ï¼Œæ‰€ä»¥è¦æ³¨æ„åœ¨æ ¹ç›®å½•çš„ .gitignore ä¸­æ·»åŠ äº§ç‰©ç›®å½• distï¼š

```diff
# .gitignore
node_modules
+dist
```

#### å…¬å…±æ–¹æ³•ä»£ç é¢„å¤‡

**packages/shared-test**
æˆ‘ä»¬å‡å®šå·¥å…·æ–¹æ³•ä¸­æœ‰ä¸€ä¸ªæ‰“å° Hello World çš„æ–¹æ³•ã€‚å¦å¤–ï¼Œä¸ºäº†æ¼”ç¤ºå¼•å…¥å¤–éƒ¨ä¾èµ–çš„å·¥ç¨‹èƒ½åŠ›ï¼Œæˆ‘ä»¬è¿˜è¦å¯¼å‡ºä¸€ä¸ªæ–¹æ³• useLodashï¼Œè¿™ä¸ªæ–¹æ³•åŸå°ä¸åŠ¨åœ°è¿”å› lodash å®ä¾‹å¯¹è±¡ã€‚index.ts ä¼šä½œä¸ºå‡ºå£ç»Ÿä¸€å¯¼å‡ºè¿™äº›æ–¹æ³•ã€‚ä¸‹é¢å±•ç¤ºæ“ä½œæ­¥éª¤ã€‚

```bash
# ä¸º shared åŒ…å®‰è£… lodash ç›¸å…³ä¾èµ–
pnpm --filter @openxui/shared i -S lodash @types/lodash
```

```js
// packages/shared/src/hello.ts
export function hello(to: string = "World") {
  const txt = `Hello ${to}!`;
  alert(txt);
  return txt;
}
```

```
// packages/shared/src/useLodash.ts
import lodash from 'lodash'

export function useLodash() {
  return lodash
}
```

```// packages/shared/src/index.ts
export * from './hello';
export * from './useLodash'
```

#### å¦‚æœéœ€è¦å¯¹å…¬å…±æ–¹æ³•æ¨¡å—è¿›è¡Œæ‰“åŒ…å¤„ç†

ä»¬åœ¨å…¬å…±æ–¹æ³•æ¨¡å— shared åŒ…ä¸­æ·»åŠ  vite.config.tsï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶å°†å‘Šè¯‰ vite å¦‚ä½•æ„å»ºè¿™ä¸ªæ¨¡å—ã€‚
ç»„ä»¶åº“é¡¹ç›®çš„æ¨¡å—è‡ªç„¶è¦ä»¥åº“æ¨¡å¼æ„å»ºï¼ŒVite èƒ½å¤Ÿå¾ˆå¥½åœ°æ”¯æŒè¿™ç§æ„å»ºæ–¹å¼ï¼Œå®˜æ–¹æ–‡æ¡£ä¹Ÿå¯¹è¿™ç§ç”¨æ³•è¿›è¡Œäº† è¯´æ˜ã€‚
æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªåº“æ¨¡å¼ä¸‹æœ€ç®€å•çš„ vite.config æ–‡ä»¶ï¼Œå¹¶å°† package.json ä¸­çš„ build è„šæœ¬ä¿®æ”¹æˆ Vite æ„å»ºæŒ‡ä»¤ã€‚

```js
// packages/shared-test/vite.config.ts
import { defineConfig } from "vite";

export default defineConfig({
  build: {
    // äº§ç‰©è¾“å‡ºç›®å½•ï¼Œé»˜è®¤å€¼å°±æ˜¯ distã€‚æˆ‘ä»¬ä½¿ç”¨é»˜è®¤å€¼ï¼Œæ³¨é‡Šæ‰æ­¤å­—æ®µã€‚
    // outDir: 'dist',

    // å‚è€ƒï¼šhttps://cn.vitejs.dev/config/build-options.html#build-lib
    lib: {
      // æ„å»ºçš„å…¥å£æ–‡ä»¶
      entry: "./src/index.ts",

      // äº§ç‰©çš„ç”Ÿæˆæ ¼å¼ï¼Œé»˜è®¤ä¸º ['es', 'umd']ã€‚æˆ‘ä»¬ä½¿ç”¨é»˜è®¤å€¼ï¼Œæ³¨é‡Šæ‰æ­¤å­—æ®µã€‚
      // formats: ['es', 'umd'],

      // å½“äº§ç‰©ä¸º umdã€iife æ ¼å¼æ—¶ï¼Œè¯¥æ¨¡å—æš´éœ²çš„å…¨å±€å˜é‡åç§°
      name: "summaryShared",
      // äº§ç‰©æ–‡ä»¶åç§°
      fileName: "summary-shared",
    },
    // ä¸ºäº†æ–¹ä¾¿å­¦ä¹ ï¼ŒæŸ¥çœ‹æ„å»ºäº§ç‰©ï¼Œå°†æ­¤ç½®ä¸º falseï¼Œä¸è¦æ··æ·†äº§ç‰©ä»£ç 
    minify: false,
  },
});
```

ç„¶åä¿®æ”¹ package.json æ–‡ä»¶ n

```diff
// packages/shared/package.json
{
  // ...
  "scripts": {
-   "build": "echo build",
+   "build": "vite build",
    "test": "echo test"
  },
}

```

ä¹‹åï¼Œæ‰§è¡Œ shared-test åŒ…çš„æ„å»ºæŒ‡ä»¤ï¼ŒVite ä¼šè‡ªåŠ¨è¯»å–å¯¹åº”çš„ vite.config æ–‡ä»¶ï¼Œç”Ÿæˆæ„å»ºäº§ç‰©ã€‚

```bash
pnpm --filter @openxui/shared run build

# ä»¥ä¸‹ä¸ºæŒ‡ä»¤è¾“å‡º
> @openxui/shared@0.0.0 build D:\learning\openx-ui\packages\shared
> vite build

vite v4.4.4 building for production...
âœ“ 6 modules transformed.
dist/openxui-shared.mjs  213.46 kB â”‚ gzip: 41.73 kB
dist/openxui-shared.umd.js  224.92 kB â”‚ gzip: 42.24 kB
âœ“ built in 1.95s
```

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒVite ä¼šä¸ºæˆ‘ä»¬ç”Ÿæˆ .mjs å’Œ .umd.js åç¼€çš„äº§ç‰©ï¼Œå¯ä»¥æ»¡è¶³ç»å¤§å¤šæ•°æƒ…å†µä¸‹å¯¹äºäº§ç‰©æ ¼å¼çš„è¦æ±‚ã€‚å…¶ä¸­ .mjs å¯¹åº” esm æ ¼å¼çš„å¯ç”¨äº§ç‰©ï¼Œ.umd.js å¯¹åº” cjs æ ¼å¼çš„å¯ç”¨äº§ç‰©ã€‚æˆ‘ä»¬æŒ‰ç…§äº§ç‰©çš„è·¯å¾„ï¼Œåœ¨ package.json ä¸­ä¿®æ”¹å¯¹åº”çš„å…¥å£å­—æ®µ

```json
// packages/shared-test/package.json
{
  // çœç•¥å…¶ä»–æ— å…³é…ç½® ...
  "main": "./dist/openxui-shared.umd.js",
  "module": "./dist/openxui-shared.mjs",
  "exports": {
    ".": {
      "require": "./dist/openxui-shared.umd.js",
      "module": "./dist/openxui-shared.mjs"
      // ...
    }
  }
}
```

æ­¤æ—¶ shared-test æ‰“åŒ…å®Œæˆï¼Œå…·ä½“ä¼˜åŒ–æ‰“åŒ…å°±ä¸åšä»‹ç»äº†
